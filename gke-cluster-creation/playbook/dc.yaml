---
- name: Create cluster
  hosts: localhost
  gather_facts: false

  vars_prompt:
    
    - name: cluster_name
      prompt: Cluster name
      private: false
    
    - name: cluster_region
      prompt: Region
      default: eastus
      private: false

    - name: k8s_version
      prompt: Kubernetes Version
      default: 1.27.9
      private: false


    - name: number_of_node
      prompt: Number of node
      default: 1
      private: false

    - name: machine_type
      prompt: VM Type
      default: n1-standard-16
      private: false

  tasks:  

  - name: create a cluster
    google.cloud.gcp_container_cluster:
      
      name: "{{ cluster_name }}"
      
      initial_node_count: "{{ number_of_node }}"
      
      node_config:
        machine_type: "{{ machine_type }}"
        disk_size_gb: 500
      
      location: "{{ cluster_region }}"
      
      project: openenv-z7ckj
      
      auth_kind: serviceaccount
      
      state: present

    register: gke_cluster_artifactcluster

  - name: Build credentials
    ansible.builtin.shell: |
      gcloud auth activate-service-account --key-file=${GCE_CREDENTIALS_FILE_PATH} && \
      gcloud container clusters get-credentials {{ cluster_name }} --location={{ cluster_region }} --project=openenv-z7ckj && \
      kubectl create sa ggg && \
      kubectl create clusterrolebinding ggg-cluster-admin --clusterrole=cluster-admin --serviceaccount=default:ggg

  - name: Get token
    ansible.builtin.shell: kubectl create token ggg
    register: gke_token

  - name: Get gke server
    ansible.builtin.shell: kubectl config view -o='jsonpath' --template='{.clusters[0].cluster.server}'
    register: gke_server


  - name: Apply k8s manifests to Hub Cluster
    redhat.openshift.k8s:
      resource_definition: "{{ lookup('ansible.builtin.template', './templates/import-cluster.yaml') }}"
      state: present
    register: hub_cluster_artifact
